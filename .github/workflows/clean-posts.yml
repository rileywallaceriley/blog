name: Clean Posts

on:
  workflow_dispatch:

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Write script
        run: |
          cat > cleaner.mjs << 'EOF'
          import fs from 'fs';
          import https from 'https';

          const API_KEY = process.env.ANTHROPIC_API_KEY || '';
          const INPUT = 'posts_complete.json';
          const OUTPUT = 'posts_cleaned.json';
          const PROGRESS = 'clean_progress.json';
          const DELAY = 600;

          const sleep = ms => new Promise(r => setTimeout(r, ms));

          function strip(text) {
            if (!text) return '';
            return text.replace(/<https?:\/\/[^>]+>/g, '').replace(/<[^>]+>/g, '').trim();
          }

          function toHTML(text) {
            if (!text) return '';
            return text.split(/\n\n+/).map(p => '<p>' + p.trim() + '</p>').filter(p => p !== '<p></p>').join('');
          }

          function api(system, user) {
            return new Promise((resolve, reject) => {
              const body = JSON.stringify({ model: 'claude-haiku-4-5-20251001', max_tokens: 4096, system, messages: [{ role: 'user', content: user }] });
              const req = https.request({ hostname: 'api.anthropic.com', path: '/v1/messages', method: 'POST', headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY, 'anthropic-version': '2023-06-01', 'Content-Length': Buffer.byteLength(body) } }, res => {
                let d = '';
                res.on('data', c => d += c);
                res.on('end', () => {
                  if (res.statusCode !== 200) { reject(new Error('API ' + res.statusCode + ' ' + d)); return; }
                  const p = JSON.parse(d);
                  resolve(p.content && p.content[0] && p.content[0].text ? p.content[0].text.trim() : null);
                });
              });
              req.on('error', reject);
              req.write(body);
              req.end();
            });
          }

          async function main() {
            console.log('Starting cleaner...');
            if (!API_KEY) { console.error('No API key'); process.exit(1); }
            if (!fs.existsSync(INPUT)) { console.error('No input file'); process.exit(1); }

            const posts = JSON.parse(fs.readFileSync(INPUT, 'utf8'));
            const total = posts.length;
            console.log('Posts: ' + total);

            let progress = fs.existsSync(PROGRESS) ? JSON.parse(fs.readFileSync(PROGRESS, 'utf8')) : {};
            const cleaned = posts.slice();
            let ok = 0, err = 0;

            for (let i = 0; i < posts.length; i++) {
              const post = posts[i];
              const key = post.post_name || String(i);
              if (progress[key]) { cleaned[i] = Object.assign({}, post, progress[key]); continue; }

              console.log('[' + (i+1) + '/' + total + '] ' + post.title.slice(0, 60));
              try {
                const t = await api('Fix only typos, spacing and punctuation in this title. Return ONLY the corrected title.', post.title);
                await sleep(DELAY);
                const c = await api('Fix typos, spacing, run-on words and broken punctuation. Preserve voice. Paragraphs separated by blank lines. Return ONLY cleaned text.', strip(post.clean_content || post.content || ''));
                await sleep(DELAY);
                const update = { title: t || post.title, clean_content: c ? toHTML(c) : (post.clean_content || post.content || ''), ai_cleaned: true };
                cleaned[i] = Object.assign({}, post, update);
                progress[key] = update;
                fs.writeFileSync(PROGRESS, JSON.stringify(progress, null, 2));
                ok++;
              } catch(e) {
                console.log('Error: ' + e.message);
                cleaned[i] = post;
                err++;
                await sleep(2000);
              }
            }

            fs.writeFileSync(OUTPUT, JSON.stringify(cleaned, null, 2));
            console.log('Done: ' + ok + ' cleaned, ' + err + ' errors. Saved ' + OUTPUT);
            if (err === 0 && fs.existsSync(PROGRESS)) fs.unlinkSync(PROGRESS);
          }

          main().catch(e => { console.error(e.message); process.exit(1); });
          EOF

      - name: Run cleaner
        run: node cleaner.mjs
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Commit cleaned posts
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add posts_cleaned.json
          git commit -m "Auto-cleaned posts" || echo "Nothing to commit"
          git push
